<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B2B Showroom</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css"/>
    <script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>
    <style> #panorama-container { width: 100%; height: 400px; border-radius: 12px; } </style>
</head>
<body class="bg-gray-100 pb-20">

    <script>
        // --- BURAYI DOLDUR KANKA (TIRNAKLARIN ƒ∞√áƒ∞NE YAPI≈ûTIR) ---
        const SUPABASE_URL ="https://gndyovpbppnjwicfetnf.supabase.co";
        const SUPABASE_KEY ="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImduZHlvdnBicHBuandpY2ZldG5mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4ODk5MTcsImV4cCI6MjA4MDQ2NTkxN30.1_IAX8FVlvuTFp1ZhQZb-IaaPxfM3Mq4Rquj6to5EfU";
        
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY)

        document.addEventListener('alpine:init', () => {
            Alpine.data('b2bApp', () => ({
                tab: 'vitrin',
                showrooms: [],
                aktifShowroom: null,
                yeniShowroom: { baslik: '', tip: 'vitrin' },
                yukleniyor: false,

                async init() { await this.verileriGetir(); },

                async verileriGetir() {
                    let { data } = await supabase.from('showrooms').select('*').order('id', { ascending: false });
                    this.showrooms = data || [];
                },

                async showroomYukle() {
                    const dosya = this.$refs.panoInput.files[0];
                    if (!dosya) return alert("Dosya se√ßmedin!");
                    
                    this.yukleniyor = true;
                    const dosyaAdi = Date.now() + '-' + dosya.name.replace(/[^a-zA-Z0-9.]/g, '');

                    // 1. Storage'a Y√ºkle ('panoramalar' senin a√ßtƒ±ƒüƒ±n bucket adƒ±)
                    const { error: upErr } = await supabase.storage.from('panoramalar').upload(dosyaAdi, dosya);
                    if (upErr) { this.yukleniyor = false; return alert('Y√ºkleme Hatasƒ±: ' + upErr.message); }

                    // 2. Linki Al
                    const { data: { publicUrl } } = supabase.storage.from('panoramalar').getPublicUrl(dosyaAdi);

                    // 3. Veritabanƒ±na Yaz
                    const { error: dbErr } = await supabase.from('showrooms').insert([{
                        baslik: this.yeniShowroom.baslik,
                        panorama_url: publicUrl,
                        tip: this.yeniShowroom.tip
                    }]);

                    this.yukleniyor = false;
                    if (dbErr) alert('DB Hatasƒ±: ' + dbErr.message);
                    else {
                        alert('Showroom Hazƒ±r! üåç');
                        this.yeniShowroom.baslik = '';
                        this.verileriGetir();
                        this.tab = 'vitrin';
                    }
                },

                showroomBaslat(url, baslik) {
                    this.aktifShowroom = baslik;
                    setTimeout(() => {
                        pannellum.viewer('panorama-container', {
                            "type": "equirectangular",
                            "panorama": url,
                            "autoLoad": true,
                            "compass": true
                        });
                    }, 100);
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            }))
        })
    </script>

    <div x-data="b2bApp" class="max-w-2xl mx-auto p-4">
        
        <div class="flex justify-between bg-white p-4 rounded-xl shadow mb-6">
            <h1 class="font-bold text-xl text-blue-900">üè≠ B2B Showroom</h1>
            <div class="space-x-2">
                <button @click="tab = 'vitrin'" :class="tab==='vitrin'?'bg-blue-600 text-white':'bg-gray-200'" class="px-3 py-1 rounded">Vitrin</button>
                <button @click="tab = 'ekle'" :class="tab==='ekle'?'bg-blue-600 text-white':'bg-gray-200'" class="px-3 py-1 rounded">Y√ºkle</button>
            </div>
        </div>

        <div x-show="aktifShowroom" class="mb-6 relative">
            <div id="panorama-container" class="shadow-xl border-4 border-white"></div>
            <button @click="aktifShowroom = null; document.getElementById('panorama-container').innerHTML=''" class="absolute top-2 right-2 bg-red-600 text-white px-3 py-1 rounded text-xs">Kapat</button>
        </div>

        <div x-show="tab === 'vitrin'" class="grid grid-cols-1 gap-4">
            <template x-for="sh in showrooms" :key="sh.id">
                <div @click="showroomBaslat(sh.panorama_url, sh.baslik)" class="bg-white p-4 rounded shadow flex items-center gap-4 cursor-pointer hover:bg-blue-50">
                    <div class="text-3xl">üîÑ</div>
                    <div>
                        <div class="font-bold" x-text="sh.baslik"></div>
                        <div class="text-xs text-gray-500" x-text="sh.tip === 'uretim' ? 'üîí √ñzel Alan' : 'üåç Herkese A√ßƒ±k'"></div>
                    </div>
                </div>
            </template>
            <div x-show="showrooms.length === 0" class="text-center text-gray-400 py-10">Hen√ºz showroom yok. ƒ∞lkini sen y√ºkle!</div>
        </div>

        <div x-show="tab === 'ekle'" class="bg-white p-6 rounded shadow space-y-4">
            <h2 class="font-bold border-b pb-2">Yeni Showroom Ekle</h2>
            <input x-model="yeniShowroom.baslik" type="text" placeholder="Showroom Adƒ±" class="w-full border p-2 rounded">
            <select x-model="yeniShowroom.tip" class="w-full border p-2 rounded"><option value="vitrin">Vitrin</option><option value="uretim">√úretim Hattƒ±</option></select>
            <input x-ref="panoInput" type="file" accept="image/*" class="w-full">
            <button @click="showroomYukle()" class="w-full bg-green-600 text-white py-3 rounded font-bold">
                <span x-text="yukleniyor ? 'Y√ºkleniyor...' : 'Kaydet ve Yayƒ±nla'"></span>
            </button>
        </div>
    </div>
</body>
</html>

